name: Trump_Automation

on:
  schedule:
    - cron: "0 14 * * *"  # 9 AM Colombia
    - cron: "0 17 * * *"  # 12 PM Colombia
    - cron: "0 23 * * *"  # 6 PM Colombia
  workflow_dispatch: {}  # Permite ejecuciÃ³n manual

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ‘… Checkout del repositorio
        uses: actions/checkout@v4

      - name: ğŸ° Instalar Node.js y dependencias
        run: |
          npm install
          npx playwright install --with-deps

      - name: ğŸš€ Ejecutar pruebas de Playwright
        id: test
        run: |
          npx playwright test --reporter=html | tee playwright-output.txt || true
          PASSED=$(grep -oE '[0-9]+ passed' playwright-output.txt | awk '{print $1}' || echo 0)
          FAILED=$(grep -oE '[0-9]+ failed' playwright-output.txt | awk '{print $1}' || echo 0)
          SKIPPED=$(grep -oE '[0-9]+ skipped' playwright-output.txt | awk '{print $1}' || echo 0)
          FLAKY=$(grep -oE '[0-9]+ flaky' playwright-output.txt | awk '{print $1}' || echo 0)
          TOTAL=$((PASSED + FAILED + SKIPPED + FLAKY))
          UNIQUE_TESTS=$(node -e "const fs=require('fs');const path=require('path');const root=path.join(process.cwd(),'tests');let count=0;const walk=(dir)=>{for(const entry of fs.readdirSync(dir,{withFileTypes:true})){const full=path.join(dir,entry.name);if(entry.isDirectory()) walk(full);else if(entry.isFile()&&entry.name.endsWith('.spec.ts')){const content=fs.readFileSync(full,'utf8');const matches=content.match(/\\btest\\s*\\(/g);if(matches) count+=matches.length;}}};walk(root);process.stdout.write(String(count));")
          FAIL_CASE=$(grep -m1 "â€º" playwright-output.txt | sed 's/"/\\"/g' || echo "")
          FAIL_ERROR=$(grep -m1 "Error:" playwright-output.txt | sed 's/"/\\"/g' || echo "")
          ERROR_REASON=$(echo "${FAIL_CASE} ${FAIL_ERROR}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' || echo "")
          echo "PASSED_COUNT=$PASSED" >> $GITHUB_ENV
          echo "FAILED_COUNT=$FAILED" >> $GITHUB_ENV
          echo "SKIPPED_COUNT=$SKIPPED" >> $GITHUB_ENV
          echo "FLAKY_COUNT=$FLAKY" >> $GITHUB_ENV
          echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_ENV
          echo "UNIQUE_TESTS_COUNT=$UNIQUE_TESTS" >> $GITHUB_ENV
          echo "ERROR_REASON=$ERROR_REASON" >> $GITHUB_ENV
          if [ -n "$ERROR_REASON" ]; then
            echo "Motivo del error: $ERROR_REASON" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ‘„ Subir reporte HTML como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report

      # Opcional: Capturas y ZIP (puedes activarlo mÃ¡s adelante si lo necesitas)
      # - name: ğŸ“‚ Copiar capturas a carpeta screenshots
      #   if: always()
      #   run: |
      #     mkdir -p screenshots
      #     find test-results -type f -name '*.png' -exec cp --parents {} screenshots/ \;

      # - name: ğŸ–¼ï¸ Comprimir capturas en ZIP
      #   if: always()
      #   run: |
      #     if [ -d "screenshots" ]; then
      #       zip -r screenshots.zip screenshots
      #     fi

      # - name: ğŸ–¼ï¸ Subir ZIP de capturas como artefacto
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: screenshots-zip
      #     path: screenshots.zip

      - name: ğŸ“¢ Notificar resultados en Google Chat
        if: always()
        run: |
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          JSON_PAYLOAD=$(cat <<EOF
          {
            "cardsV2": [
              {
                "cardId": "results_card",
                "card": {
                  "header": {
                    "title": "ğŸ•µï¸ Resultados de pruebas Nuevo TRUMP",
                    "subtitle": "Resumen de ejecuciÃ³n"
                  },
                  "sections": [
                    {
                      "widgets": [
                        {
                          "textParagraph": {
                            "text": "âœ… Satisfactorias: *${{ env.UNIQUE_TESTS_COUNT }}*  |  âŒ Fallidas: *${{ env.FAILED_COUNT }}*  |  âš ï¸ Inestables: *${{ env.FLAKY_COUNT }}*  |  â­ Omitidas: *${{ env.SKIPPED_COUNT }}*  |  ğŸ“Š Total: *${{ env.UNIQUE_TESTS_COUNT }}*"
                          }
                        },
                        {
                          "textParagraph": {
                            "text": "ğŸ§¾ Motivo: ${{ env.ERROR_REASON }}"
                          }
                        },
                        {
                          "buttonList": {
                            "buttons": [
                              {
                                "text": "ğŸ” CONSULTAR EVIDENCIAS",
                                "onClick": {
                                  "openLink": {
                                    "url": "$WORKFLOW_URL"
                                  }
                                }
                              }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
          EOF
          )
          curl -X POST -H 'Content-Type: application/json' \
            -d "$JSON_PAYLOAD" \
            "https://chat.googleapis.com/v1/spaces/AAAAOzKWJJQ/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=YFmBV6rljIYSHXdLP2ozpebmaaYRbJFCA-8HezJrGPs"
