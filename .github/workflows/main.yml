name: Playwright Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout del repositorio
        uses: actions/checkout@v4

      - name: 🏗️ Instalar dependencias (Node.js + Playwright + jq)
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          npx playwright install --with-deps
          npm install

      - name: 🚀 Ejecutar pruebas de Playwright
        id: test
        run: |
          mkdir -p playwright-reports

          # Ejecutar pruebas con reporte en JSON
          npx playwright test --reporter=json --output=playwright-reports | tee playwright-output.json

          # Extraer datos de pruebas
          PASSED=$(jq '[.suites[].specs[].tests[].results[] | select(.status=="passed")] | length' playwright-output.json)
          FAILED=$(jq '[.suites[].specs[].tests[].results[] | select(.status=="failed")] | length' playwright-output.json)
          SKIPPED=$(jq '[.suites[].specs[].tests[].results[] | select(.status=="skipped")] | length' playwright-output.json)
          TOTAL=$((PASSED + FAILED + SKIPPED))

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

      - name: 📤 Subir reporte JSON
        uses: actions/upload-artifact@v4
        with:
          name: playwright-json-report
          path: playwright-output.json

      - name: 📢 Notificar resultados en Google Chat
        run: |
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          STATUS_MESSAGE="🧪 *Pruebas Playwright*\n✅ Pasadas: $PASSED | ❌ Fallidas: $FAILED | ⏭ Omitidas: $SKIPPED | 📊 Total: $TOTAL\n🔗 [Detalles]($WORKFLOW_URL)"

          curl -X POST -H 'Content-Type: application/json' \
            -d "{\"text\": \"$STATUS_MESSAGE\"}" \
            "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
